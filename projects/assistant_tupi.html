<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with AssistantTupi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .chat-container {
            border: 1px solid #ddd;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            margin-bottom: 20px;
        }
        .chat-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .chat-message.user {
            background-color: #d5f5e3;
            text-align: right;
        }
        .chat-message.assistant {
            background-color: #e8eaf6;
            text-align: left;
        }
        .input-container {
            display: flex;
        }
        .input-container input {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .input-container button {
            width: 20%;
            padding: 10px;
            font-size: 16px;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #2980b9;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Chat with AssistantTupi</h1>
    <div class="chat-container" id="chatContainer">
        <!-- Chat messages will be appended here -->
    </div>
    <div class="input-container">
        <input type="text" id="userInput" placeholder="Type your question...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    const passphrase = 'Sator Arepo Tenet Opera Rotas';
    const encryptedUrl = 'U2FsdGVkX18JIQD0HF5sMYrCjG5orqnzfQFP0Nw2nJdKzhMzQVPhQAvb+ieYBMniw8SghQT4SoTdTf3Q7Y4R2w==';
    const encryptedApiKey = 'U2FsdGVkX1/oCIAz+icFaHd3LY50geeZ7jwnMrLicS8xBwB4DnvpyAYcs637A0fDzyVgB50BQv+WdUgUoT4mXw==';
    function decrypt(encryptedValue) {
        return CryptoJS.AES.decrypt(encryptedValue, passphrase).toString(CryptoJS.enc.Utf8);
    }

    let threadId = '';
    let assistantId = '';
    let thinkingMessageDiv = null;

    async function createAssistant() {
        try {
            const response = await fetch(`${decrypt(encryptedUrl)}/openai/assistants?api-version=2024-05-01-preview`, {
                method: 'POST',
                headers: {
                    'api-key': decrypt(encryptedApiKey),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "instructions": "You are an expert in indigenous languages. Do not answer anything that is not related to indigenous languages.",
                    "name": "AssistantTupi",
                    "tools": [
                        {
                            "type": "file_search"
                        }
                    ],
                    "model": "gpt-4o",
                    "tool_resources": {
                        "file_search": {
                            "vector_store_ids": [
                                "vs_2YiZ8i4K07OMAMjfeocl2hkw"
                            ]
                        }
                    },
                    "temperature": 1,
                    "top_p": 1
                })
            });
    
            const data = await response.json();
            console.log("Create Assistant Response: ", data);
    
            if (data.id) {
                assistantId = data.id;
                console.log(`Assistant ID: ${assistantId}`);
                createThread();
            } else {
                console.error(`Failed to create assistant: `, data);
            }
        } catch (error) {
            console.error(`Error creating assistant: ${error}`);
        }
    }
    
    async function createThread() {
        try {
            const response = await fetch(`${decrypt(encryptedUrl)}/openai/threads?api-version=2024-05-01-preview`, {
                method: 'POST',
                headers: {
                    'api-key': decrypt(encryptedApiKey),
                    'Content-Type': 'application/json'
                },
                body: ''
            });
    
            const data = await response.json();
            console.log("Create Thread Response: ", data);
    
            if (data.id) {
                threadId = data.id;
                console.log(`Thread ID: ${threadId}`);
            } else {
                console.error(`Failed to create thread: `, data);
            }
        } catch (error) {
            console.error(`Error creating thread: ${error}`);
        }
    }
    
    async function sendMessage() {
        if (!threadId) {
            console.error('Thread ID is undefined.');
            return;
        }

        const userInput = document.getElementById('userInput').value;
        if (!userInput) return;

        appendMessage('user', userInput);

        try {
            const response = await fetch(`${decrypt(encryptedUrl)}/openai/threads/${threadId}/messages?api-version=2024-05-01-preview`, {
                method: 'POST',
                headers: {
                    'api-key': decrypt(encryptedApiKey),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "role": "user",
                    "content": userInput
                })
            });

            const data = await response.json();
            console.log("Send Message Response: ", data);

            if (response.ok) {
                showThinkingMessage();
                runThread();
            } else {
                console.error(`Failed to send message: `, data);
            }
        } catch (error) {
            console.error(`Error sending message: ${error}`);
        }
    }

    async function runThread() {
        if (!threadId || !assistantId) {
            console.error('Thread ID or Assistant ID is undefined.');
            return;
        }
    
        try {
            const response = await fetch(`${decrypt(encryptedUrl)}/openai/threads/${threadId}/runs?api-version=2024-05-01-preview`, {
                method: 'POST',
                headers: {
                    'api-key': decrypt(encryptedApiKey),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    "assistant_id": assistantId 
                })
            });
    
            const data = await response.json();
            console.log("Run Thread Response: ", data);
    
            if (response.ok && data.id) {
                const runId = data.id;
                console.log(`Run ID: ${runId}`);
                // Continuar verificando o status até que seja "completed"
                checkRunStatus(runId);
            } else {
                console.error(`Failed to run thread: `, data);
            }
        } catch (error) {
            console.error(`Error running thread: ${error}`);
        }
    }
    
    async function checkRunStatus(runId) {
        try {
            const response = await fetch(`${decrypt(encryptedUrl)}/openai/threads/${threadId}/runs/${runId}?api-version=2024-05-01-preview`, {
                method: 'GET',
                headers: {
                    'api-key': decrypt(encryptedApiKey),
                    'Content-Type': 'application/json'
                }
            });
    
            const data = await response.json();
            console.log("Check Run Status Response: ", data);
    
            if (response.ok && data.status === 'completed') {
                removeThinkingMessage();
                getAssistantResponse();
            } else if (data.status === 'queued' || data.status === 'in_progress') {
                console.log(`Status is ${data.status}, checking again in 1 second...`);
                setTimeout(() => checkRunStatus(runId), 1000);
            } else {
                removeThinkingMessage();
                console.error(`Error checking run status: `, data);
            }
        } catch (error) {
            removeThinkingMessage();
            console.error(`Error checking run status: ${error}`);
        }
    }
    
    async function getAssistantResponse() {
        try {
            const response = await fetch(`${decrypt(encryptedUrl)}/openai/threads/${threadId}/messages?api-version=2024-05-01-preview`, {
                method: 'GET',
                headers: {
                    'api-key': decrypt(encryptedApiKey),
                    'Content-Type': 'application/json'
                }
            });
    
            const data = await response.json();
            console.log("Get Assistant Response: ", data);
    
            if (response.ok && Array.isArray(data.data)) {
                const assistantMessage = data.data.find(message => message.role === 'assistant');
                if (assistantMessage) {
                    let messageContent = assistantMessage.content;
    
                    // Verifica se o conteúdo é um array de objetos e processa apropriadamente
                    if (Array.isArray(messageContent)) {
                        messageContent = messageContent.map(item => {
                            if (item.type === 'text' && item.text && item.text.value) {
                                return item.text.value;
                            }
                            return null;
                        }).filter(item => item !== null).join("\n"); // Junta todas as partes relevantes em uma string
                    } else if (typeof messageContent === 'object') {
                        messageContent = JSON.stringify(messageContent, null, 2);
                    }
    
                    // Remover referências de fonte como  
                    messageContent = messageContent.replace(/【[\d:†source]+】/g, '');
    
                    appendMessage('assistant', messageContent);
                } else {
                    console.error('No assistant message found.');
                }
            } else {
                console.error(`Failed to get assistant response: `, data);
            }
        } catch (error) {
            console.error(`Error getting assistant response: ${error}`);
        }
    }
              
    function appendMessage(role, content) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', role);
        messageDiv.textContent = content;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        document.getElementById('userInput').value = '';
    }

    function showThinkingMessage() {
        const chatContainer = document.getElementById('chatContainer');
        thinkingMessageDiv = document.createElement('div');
        thinkingMessageDiv.classList.add('chat-message', 'assistant');
        thinkingMessageDiv.textContent = 'Assistant is thinking. Please wait...';
        chatContainer.appendChild(thinkingMessageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeThinkingMessage() {
        if (thinkingMessageDiv) {
            thinkingMessageDiv.remove();
            thinkingMessageDiv = null;
        }
    }

    createAssistant();
</script>

</body>
</html>
